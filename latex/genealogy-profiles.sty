\RequirePackage{expl3}[2023/10/10]
\ProvidesExplPackage{genealogy-profiles}{2023/11/09}{0.1}{Macros for creating genealogical profiles}

% License: CC-BY-SA 4.0
% Author: Mikkel Eide Eriksen <mikkel.eriksen@gmail.com>

\RequirePackage{xcolor}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Key setup
% 

\keys_define:nn { genealogy-profiles }
{
	% formatting
	before~profile				.tl_set:N		= \l__gpr_before_profile_tl ,
	split~profile				.tl_set:N		= \l__gpr_split_profile_tl ,
	after~profile				.tl_set:N		= \l__gpr_after_profile_tl ,

	name~part~order				.code:n			= {
			\seq_gset_from_clist:Nn \g__gpr_name_part_order_seq {#1}
		} ,
%	name part formatting
}

% set some defaults
\keys_set:nn { genealogy-profiles } {
	name~part~order = { givenname, patronymic, surname, byname } ,
}

\keys_define:nn { genealogy-profiles / profile }
{
	id							.tl_set:N		= \l__gpr_id_tl ,
%	fullname?
	givenname					.tl_set:N		= \l__gpr_givenname_tl ,
	patronymic					.tl_set:N		= \l__gpr_patronymic_tl ,
	surname						.tl_set:N		= \l__gpr_surname_tl ,
	byname						.tl_set:N		= \l__gpr_byname_tl ,
	name~parts					.code:n			= {
			\seq_set_from_clist:Nn \l_tmpa_seq {#1}
			\tl_clear_new:N \l__gpr_tmpid_tl
			\seq_map_indexed_inline:Nn \g__gpr_name_part_order_seq {
				\tl_set:ce { l__gpr_##2_tl } { \seq_item:Nn \l_tmpa_seq {##1} } 

				% build id
				\tl_if_empty:cTF { l__gpr_##2_tl } {
					\tl_put_right:Ne \l__gpr_tmpid_tl { x }
				} {
					\tl_put_right:Ne \l__gpr_tmpid_tl { \tl_item:cn { l__gpr_##2_tl } {1} }
				}
			}

			% set id unless already defined
			\tl_if_empty:NT \l__gpr_id_tl {
				\tl_clear_new:N \l__gpr_generated_id_tl
				\gpr_generate_unique_id:Ne \l__gpr_generated_id_tl {\l__gpr_tmpid_tl}
				\seq_gput_right:Ne \g__gpr_used_profile_ids_seq \l__gpr_generated_id_tl
				\tl_set_eq:NN \l__gpr_id_tl \l__gpr_generated_id_tl
			}
		} ,

%	vital data / genealogytree
}

\NewDocumentCommand { \gprKeys } { m } {
	\keys_set:nn { genealogy-profiles } { #1 }
}

% \property_new:nnnn { genealogy-profiles / floruit }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Formatting
% 

\seq_clear_new:N \g__gpr_used_profile_ids_seq
\bool_new:N \l__gpr_id_exists_bool

\cs_new_protected:Nn \gpr_generate_unique_id:Nn
{
	\int_zero_new:N \l__gpr_id_index_int

	\bool_set_false:N \l__gpr_id_exists_bool
	\bool_do_until:nn { ! \l__gpr_id_exists_bool } {
		\int_incr:N \l__gpr_id_index_int
		\seq_if_in:NeTF \g__gpr_used_profile_ids_seq { #2 \int_use:N \l__gpr_id_index_int }
			{ \bool_set_true:N \l__gpr_id_exists_bool }
			{ \bool_set_false:N \l__gpr_id_exists_bool }
	}

	\tl_set:Ne #1 { #2 \int_use:N \l__gpr_id_index_int }
}
\cs_generate_variant:Nn \gpr_generate_unique_id:Nn {
	Ne
}


\cs_new_protected:Nn \gpr_format_name:N
{
	\seq_clear_new:N \l__gpr_formatted_name_seq

	% TODO
	\seq_put_right:Nn \l__gpr_formatted_name_seq { \l__gpr_givenname_tl }
	\seq_put_right:Nn \l__gpr_formatted_name_seq { \textit{ \l__gpr_patronymic_tl } }
	\seq_put_right:Nn \l__gpr_formatted_name_seq { \textsc{ \l__gpr_byname_tl } }

	\tl_set:Nn #1 { \seq_use:Nn \l__gpr_formatted_name_seq {~} }
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% User commands
% 

% TODO starred with just name parts
\NewDocumentEnvironment { gprProfile } { O{} } {
	\group_begin:
		\tl_use:N \l__gpr_before_profile_tl
		\keys_set:nn { genealogy-profiles / profile } { #1 }
		\label{ gprProfile:\tl_use:N \l__gpr_id_tl }
		\property_record:ee { gprProfile:\tl_use:N \l__gpr_id_tl } { label, page }
		\tl_clear_new:N \l__gpr_formatted_name_tl
		\gpr_format_name:N \l__gpr_formatted_name_tl
		\tl_use:N \l__gpr_formatted_name_tl \hfill [\tl_use:N \l__gpr_id_tl] \par
		\tl_use:N \l__gpr_split_profile_tl
}{
		\tl_use:N \l__gpr_after_profile_tl
	\group_end:
}

\NewDocumentCommand { \genRef } { o m } {
	\IfValueTF{#1}{
		#2
		\textsuperscript{#1,~p.~\property_ref:nn {gprProfile:#1} {page}}
		% log from to
	}{
		% log unlinked
		{\color{red}#2}
	}
}

\NewDocumentCommand { \genDate } { m } {
	% floruit
	#1
}
