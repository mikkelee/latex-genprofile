\RequirePackage{expl3}[2023-10-10]
\ProvidesExplPackage{genealogy-profiles}{2023/11/13}{0.1}{Macros for creating genealogical profiles}

% License: CC-BY-SA 4.0
% Author: Mikkel Eide Eriksen <mikkel.eriksen@gmail.com>

\RequirePackage{hyperref}
\RequirePackage{genealogytree}
\RequirePackage{xcolor}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Key setup
% 

\keys_define:nn { genealogy-profiles }
{
	name~part~order				.code:n			= {
			\seq_gset_from_clist:Nn \g__gpr_name_part_order_seq {#1}
		} ,

	% formatting profiles
	begin~profile				.tl_set:N		= \l__gpr_begin_profile_tl ,
	after~header				.tl_set:N		= \l__gpr_after_header_tl ,
	after~vital~data			.tl_set:N		= \l__gpr_after_vital_data_tl ,
	end~profile					.tl_set:N		= \l__gpr_end_profile_tl ,
%	reference style?

	% name styling
	givenname~style				.tl_set:N		= \l__gpr_givenname_style_tl ,
	patronymic~style			.tl_set:N		= \l__gpr_patronymic_style_tl ,
	surname~style				.tl_set:N		= \l__gpr_surname_style_tl ,
	byname~style				.tl_set:N		= \l__gpr_byname_style_tl ,

	autoheader		 			.bool_set:N 	= \l__gpr_autoheader_bool ,
}

% set some defaults
\keys_set:nn { genealogy-profiles } {
	name~part~order = { givenname, patronymic, surname, byname } ,
}

\keys_define:nn { genealogy-profiles / profile }
{
	id							.tl_set:N		= \l__gpr_id_tl ,
%	fullname?
	givenname					.tl_set:N		= \l__gpr_givenname_tl ,
	patronymic					.tl_set:N		= \l__gpr_patronymic_tl ,
	surname						.tl_set:N		= \l__gpr_surname_tl ,
	byname						.tl_set:N		= \l__gpr_byname_tl ,
	name~parts					.code:n			= {
			\seq_set_from_clist:Nn \l_tmpa_seq {#1}
			\tl_clear_new:N \l__gpr_tmpid_tl
			\seq_map_indexed_inline:Nn \g__gpr_name_part_order_seq {
				\tl_set:ce { l__gpr_##2_tl } { \seq_item:Nn \l_tmpa_seq {##1} } 

				% build id
				\tl_if_empty:cTF { l__gpr_##2_tl } {
					\tl_put_right:Ne \l__gpr_tmpid_tl { x }
				} {
					\tl_put_right:Ne \l__gpr_tmpid_tl { \tl_item:cn { l__gpr_##2_tl } {1} }
				}
			}

			% set id unless already defined
			\tl_if_empty:NT \l__gpr_id_tl {
				\tl_clear_new:N \l__gpr_generated_id_tl
				\gpr_generate_unique_id:Ne \l__gpr_generated_id_tl {\l__gpr_tmpid_tl}
				\seq_gput_right:Ne \g__gpr_used_profile_ids_seq \l__gpr_generated_id_tl
				\tl_set_eq:NN \l__gpr_id_tl \l__gpr_generated_id_tl
			}
		} ,

	vital~data					.tl_set:N		= \l__gpr_vital_data_tl ,
}

\NewDocumentCommand { \gprKeys } { +m } {
	\keys_set:nn { genealogy-profiles } { #1 }
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Errors and warnings
% 

\msg_new:nnn
{ genealogy-profiles } { reference-recorded }
{ Reference ~ recorded ~ from ~ #1 ~ to ~ #2 }

\msg_new:nnn
{ genealogy-profiles } { unlabeled-reference }
{ Unlabeled ~ reference: ~ #1 }

\msg_new:nnn
{ genealogy-profiles } { missing-backref }
{ Missing ~ backreference: ~ #1 ~ refers ~ to ~ #2 ~ but ~ not ~ vice ~ versa! }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% IDs and references
% 

\seq_clear_new:N \g__gpr_used_profile_ids_seq
\bool_new:N \l__gpr_id_exists_bool

\cs_new_protected:Nn \gpr_generate_unique_id:Nn
{
	\int_zero_new:N \l__gpr_id_index_int

	\bool_set_false:N \l__gpr_id_exists_bool
	\bool_do_until:nn { ! \l__gpr_id_exists_bool } {
		\int_incr:N \l__gpr_id_index_int
		\seq_if_in:NeTF \g__gpr_used_profile_ids_seq { #2 \int_use:N \l__gpr_id_index_int }
			{ \bool_set_true:N \l__gpr_id_exists_bool }
			{ \bool_set_false:N \l__gpr_id_exists_bool }
	}

	\tl_set:Ne #1 { #2 \int_use:N \l__gpr_id_index_int }
}
\cs_generate_variant:Nn \gpr_generate_unique_id:Nn {
	Ne
}

\prop_new:N \g__gpr_references_prop

\cs_new_protected:Nn \gpr_save_reference:nn
{
	\prop_if_in:NnTF \g__gpr_references_prop { #1 } {
		\prop_get:NnN \g__gpr_references_prop { #1 } \l_tmpa_tl
	} {
		\tl_clear:N \l_tmpa_tl
	}

	% wrap ID as _ID_ so we can match them out later
	\tl_put_right:Nn \l_tmpa_tl { _#2_ }

	\prop_gput:NnV \g__gpr_references_prop { #1 } \l_tmpa_tl
}
\cs_generate_variant:Nn \gpr_save_reference:nn {
	Vn
}

\cs_new_protected:Nn \gpr_check_single_reference:nn
{
	\regex_extract_all:nnN { _([^_]+)_ } {#2} \l_tmpa_seq
	\seq_map_inline:Nn \l_tmpa_seq {
		% dont test entire matches (_ID_), only submatches (ID)
		\tl_if_eq:neF { _ } { \tl_item:nn { ##1 } {1} }
		{
			\prop_get:NnN \g__gpr_references_prop {##1} \l_tmpa_tl
			\regex_match:nVF { #1 } { \l_tmpa_tl } {
				\msg_warning:nnnn { genealogy-profiles } { missing-backref }
					{#1} {##1}
			}
		}
	}
}

\cs_new:Nn \gpr_check_all_references:
{
	\prop_map_inline:Nn \g__gpr_references_prop {
		\gpr_check_single_reference:nn {##1} {##2}
	}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Formatting
% 

\cs_new_protected:Nn \gpr_style_name:N
{
	\seq_clear_new:N \l__gpr_styled_name_seq

	\seq_map_inline:Nn \g__gpr_name_part_order_seq {
		\seq_put_right:Nn \l__gpr_styled_name_seq
			{
				\group_begin:
					\tl_use:c { l__gpr_##1_style_tl }
					\tl_use:c { l__gpr_##1_tl }
				\group_end:
			}
	}

	\tl_set:Nn #1 { \seq_use:Nn \l__gpr_styled_name_seq {~} }
}

\cs_new_protected:Nn \gpr_format_floruit:N
{
	\int_compare:nNnTF { \seq_count:N \l__floruit_years_seq } = {1}
	{
		\tl_set:Ne #1 { floruit- = { \seq_item:Nn \l__floruit_years_seq {1} } }
	}
	{
		\int_zero_new:N \l__gpr_floruit_from_int
		\int_set:Nn \l__gpr_floruit_from_int { 9999 }
		\int_zero_new:N \l__gpr_floruit_to_int
		\int_set:Nn \l__gpr_floruit_to_int { 0000 }
		\seq_map_inline:Nn \l__floruit_years_seq {
			\int_set:Nn \l__gpr_floruit_from_int { \int_min:nn {##1} { \l__gpr_floruit_from_int } }
			\int_set:Nn \l__gpr_floruit_to_int { \int_max:nn {##1} { \l__gpr_floruit_to_int } }
		}
		\tl_set:Ne #1 { floruit- = { \int_use:N \l__gpr_floruit_from_int / \int_use:N \l__gpr_floruit_to_int } }
	}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% User commands
% 

\cs_new_protected:Nn \gpr_set_gtr_keys:n
{
	\gtrset{ database/.cd, #1 }
}
\cs_generate_variant:Nn \gpr_set_gtr_keys:n {
	V
}

\gtrDeclareDatabaseFormat{gtr_db_format}{}{%
  \begin{gtrprintlist}{\par}{\unskip,\ }{\unskip.}{\unskip}%
    \gtr@list@event{birth}%
    \gtr@list@event{baptism}%
    \gtr@list@event{floruit}%
    \gtr@list@event{death}%
    \gtr@list@event{burial}%
  \end{gtrprintlist}%
  \gtr@print@infolist%
}
\gtrset{database~format=gtr_db_format}


\property_new:nnnn { floruit-years } { now } { \c_novalue_tl } {
	\seq_use:Nn \l__floruit_years_seq {,}
}

\prg_generate_conditional_variant:Nnn \property_if_recorded:nn
	{ ee } { T }

% TODO starred with just name parts
\NewDocumentEnvironment { gprProfile } { O{} } {
	\group_begin:
		\keys_set:nn { genealogy-profiles / profile } { #1 }

		% init floruit years
		\seq_clear_new:N \l__floruit_years_seq
		\property_if_recorded:eeT { gprProfile:\tl_use:N \l__gpr_id_tl } { floruit-years } {
			\tl_set:Ne \l_tmpa_tl { \property_ref:ee { gprProfile:\tl_use:N \l__gpr_id_tl } { floruit-years } }
			\seq_set_split:NnV \l__floruit_years_seq {,} \l_tmpa_tl
		}
		\seq_if_empty:NF \l__floruit_years_seq {
			\tl_clear_new:N \l__formatted_floruit_tl
			\gpr_format_floruit:N \l__formatted_floruit_tl
			\gpr_set_gtr_keys:V \l__formatted_floruit_tl
			% make sure vital data exists
			\tl_put_right:Nn \l__gpr_vital_data_tl {~}
		}

		% format name
		\tl_clear_new:N \l__gpr_styled_name_tl
		\gpr_style_name:N \l__gpr_styled_name_tl
		\cs_set:Npe \NAME { \tl_use:N \l__gpr_styled_name_tl }
		\cs_set:Npe \ID { \tl_use:N \l__gpr_id_tl }

		% set hyperref target just before typesetting
		\MakeLinkTarget*{ gprProfile:\tl_use:N \l__gpr_id_tl }

		% begin typesetting
		\tl_use:N \l__gpr_begin_profile_tl

		% record properties for id
		\property_record:ee { gprProfile:\tl_use:N \l__gpr_id_tl } { label, page, target }

		\bool_if:NT \l__gpr_autoheader_bool {
			\tl_use:N \l__gpr_styled_name_tl \hfill \tl_use:N \l__gpr_id_tl
			\tl_use:N \l__gpr_after_header_tl
		}

		% typeset vital data
		\tl_if_empty:NF \l__gpr_vital_data_tl {
			\gpr_set_gtr_keys:V \l__gpr_vital_data_tl
			\gtrPrintDatabase

			\tl_use:N \l__gpr_after_vital_data_tl
		}
}{
		% end typesetting
		\tl_use:N \l__gpr_end_profile_tl

		% save floruit years
		\seq_if_empty:NF \l__floruit_years_seq {
			\property_record:ee { gprProfile:\tl_use:N \l__gpr_id_tl } { floruit-years }
		}
	\group_end:
}

\NewDocumentCommand { \gprRef } { o m } {
	\IfValueTF{#1}{
		#2
		\textsuperscript{
			\hyperlink{ \property_ref:nn { gprProfile:#1 } { target } }{#1}~
			p.~
			\property_ref:nnn { gprProfile:#1 } { page } { { \color{red}\bfseries ??} }
			\property_ref_undefined_warn:n { gprProfile:#1 }
		}
%		\msg_note:nnee { genealogy-profiles } { reference-recorded } { \tl_use:N \l__gpr_id_tl } { #1 }
		\gpr_save_reference:Vn \l__gpr_id_tl { #1 }
	}{
		\msg_warning:nnn { genealogy-profiles } { unlabeled-reference } { #2 }
		{\color{red}#2}
	}
}

\NewDocumentCommand { \gprYear } { m } {
	% record floruit year
	\seq_if_in:NnF \l__floruit_years_seq {#1} {
		\seq_gput_right:Nn \l__floruit_years_seq {#1}
	}
	#1
}

\NewDocumentCommand { \gprCheckReferences } { } {
	\gpr_check_all_references:
}
